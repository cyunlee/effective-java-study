## item 80

### 스레드보다는 실행자, 태스크, 스트림을 애용하라

---

### 🙋 실행자 프레임워크란 무엇이며, 기존의 작업 큐 방식과 비교했을 때 어떤 장점이 있나요?

이 책 초판의 아이템 49에서는 단순한 작업 큐를 선보였는데, 
예시용 클래스였지만 책 한 페이지를 가득 메웠는데, 
`안전 실패나 응답 불가가 될 여지를 없애는 코드를 추가`해야 했기 때문입니다.

이 책의 2판이 나오기 앞서 `java.util.concurrent` 패키지가 나왔습니다.
이 패키지는 `실행자 프레임워크` 라고 하는 인터페이스 기반의 `유연한 태스크 실행 기능`을 담고 있습니다.

✔ 실행자 생성
```java
ExecutorService exec = Executors.newSingleThreadExeecutor();
```

✔ 샐행할 task 넘기는 방법
```java
exec.execute(runnable);
```

✔ 실행자 종료
```java
exec.shutdown();
```

그 외로, 
- 특정 태스크가 완료되기를 기다리는 것
- 태스크 모음 중 아무것 하나 혹은 모든 태스크가 완료되기를 기다리는 것
- 실행자 서비스가 종료하기를 기다리는 것
- 완료된 태스크들의 결과를 차례로 받는 것
- 태스크를 특정 시간에 혹은 주기적으로 실행하게 하는 것
등 다양한 기능이 있습니다.

---

### 🙌 실행자 서비스는 유연한 태스크 처리 방식을 갖고 있다.

큐를 둘 이상의 스레드가 처리하게 하고 싶다면 간단히 `다른 정적 팩터리를 이용하여 다른 종류의 실행자 서비스를 생성`하면 됩니다.
스레드 풀의 스레드 개수는 고장할 수도 있고 필요에 따라 늘어나거나 줄어들게 설정할 수도 있습니다.

필요한 실행자 대부분은 `java.util.concurrent.Executors`의 정적 팩터리를 이용해 생성 가능합니다.
평범하지 않은 실행자를 원한다면 ThreadPoolExecutor 클래스를 직접 사용해 스레드 풀 동작을 결정하는 거의 모든 속성을 설정할 수도 있습니다.

---

### 🙌 실행자 서비스를 사용할 때 고려할 점

작은 프로그램이나 가벼운 서버라면 `Executors.newCachedThreadPool()`이 일반적으로 좋은 선택입니다. 별다른 설정 없이 자동으로 동작하며, 필요에 따라 스레드를 동적으로 관리하기 때문입니다.

하지만 **무거운 프로덕션 서버에서는 `CachedThreadPool`을 신중하게 사용해야 합니다.**
- `CachedThreadPool`은 태스크를 큐에 저장하지 않고 즉시 스레드에 위임하여 실행합니다.
- **가용한 스레드가 없다면 새 스레드를 생성**하므로, 부하가 급증하면 스레드 개수가 폭발적으로 증가할 수 있습니다.
- 결과적으로 CPU 사용률이 100%에 도달하며, 스레드가 과도하게 생성되면서 서버 성능이 저하될 위험이 있습니다.

이러한 경우에는 **스레드 개수를 고정한 `Executors.newFixedThreadPool()`을 사용하거나, 직접 `ThreadPoolExecutor`를 설정하여 세밀하게 조정하는 것이 바람직합니다.**

---

### 🙌 작업 큐를 직접 구현하거나 스레드를 직접 다루는 것은 피해야 한다.

스레드를 직접 다루면 `Thread`가 **작업 단위(task)와 실행 매커니즘(execution mechanism) 역할을 모두 수행**하게 됩니다. 이는 코드 복잡도를 높이고 유지보수를 어렵게 만듭니다.

반면, `실행자 프레임워크`에서는 **작업 단위와 실행 매커니즘이 분리**됩니다.

✔ 작업 단위를 나타내는 핵심 개념: `태스크(Task)`
- 태스크를 표현하는 주요 인터페이스는 `Runnable`과 `Callable`입니다.

✔ 태스크 실행을 담당하는 매커니즘: `실행자 서비스(ExecutorService)`
- 태스크 실행을 실행자 서비스에 맡기면 원하는 실행 정책을 쉽게 선택하고 변경할 수 있습니다.

핵심은, **실행자 프레임워크를 활용하면 작업 실행을 보다 효율적이고 안정적으로 관리할 수 있다는 점**입니다.

---

### 🙌 자바 7이 되면서 실행자 프레임워크는 포크-조인 태스크를 지원하도록 확장되었다.

`포크-조인 태스크`는 `포크-조인 풀`이라는 특별한 실행자 서비스가 실행해줍니다.
`포크-조인 태스크(ForkJoinTask의 인스턴스)`는 `작은 하위 태스크`로 나뉠 수 있습니다.
`ForkJoinPool`을 구성하는 스레드들이 이 태스크들을 처리하며, 
일을 먼저 끝낸 스레드는 다른 스레드의 남은 태스크를 가져와 대신 처리할 수도 있습니다.

모든 스레드가 바쁘게 움직여 CPU를 최대한 활용하면서 높은 처리량과 낮은 지연시간을 달성하게 됩니다.

이런 포크-조인 태스크를 직접 작성하고 튜닝하긴 어렵지만, 이를 이용해 만든 병렬 스트림을 이용하면 이점을 적은 노력으로 활용할 수 있습니다.


